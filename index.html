<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible"
    content="ie=edge">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.17/vue.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gauge.js/1.3.6/gauge.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.js"></script>
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css" />
  <title>mandana.ml</title>
</head>

<body>
  <div id="app" />

  <script>
    const gaugeOptions = {
      limitMax: false,     // If false, max value increases automatically if value > maxValue
      limitMin: false,     // If true, the min value of the gauge will be fixed
      highDpiSupport: true,     // High resolution support
    };

    const vm = new Vue({
      el: '#app',

      template: `
        <div class="container" style="margin-top: 2rem;">
          <div class="columns">
            <div class="column has-text-centered">
              <h4 class="title is-4">Inlet</h4>
              <div style="margin-bottom: 1rem;">
                Last updated: {{ lastUpdated('inlet') }}
              </div>
              <label class="label">
                {{ sensors.inlet.length ? sensors.inlet[0].humidity + '%' : '-%' }}
              </label>
              <canvas id="inlet-humidity"/>
              <label class="label">
                {{ sensors.inlet.length ? sensors.inlet[0].temperature + 'ยบ' : '-ยบ' }}
              </label>
              <canvas id="inlet-temperature"/>
            </div>
            <div class="column has-text-centered">
              <h4 class="title is-4">Outlet</h4>
              <div style="margin-bottom: 1rem;">
                Last updated: {{ lastUpdated('outlet') }}
              </div>
              <label class="label">
                {{ sensors.outlet.length ? sensors.outlet[0].humidity + '%' : '-%' }}  
              </label>
              <canvas id="outlet-humidity"/>
              <label class="label">
                {{ sensors.outlet.length ? sensors.outlet[0].temperature + 'ยบ' : '-ยบ' }}
              </label>
              <canvas id="outlet-temperature"/>
            </div>
          </div>
        </div>
      `,

      computed: {
        lastUpdated() {
          return (sensor) => {
            if (this.sensors[sensor].length) {
              return moment(this.sensors[sensor][0].timestamp).format('ddd MMM D h:mm:ss a');
            }
            return 'never';
          }
        },
      },

      data() {
        return {
          socket: null,
          sensors: {
            inlet: [],
            outlet: [],
          },
          gauges: {
            inlet: {
              humidity: null,
              temperature: null,
            },
            outlet: {
              humidity: null,
              temperature: null,
            },
          }
        };
      },

      watch: {
        'sensors.inlet'(newInletData) {
          if (newInletData.length > 0) {
            this.gauges.inlet.humidity.set(newInletData[0].humidity);
            this.gauges.inlet.temperature.set(newInletData[0].temperature);
          }
        },
        'sensors.outlet'(newOutletData) {
          if (newOutletData.length > 0) {
            this.gauges.outlet.humidity.set(newOutletData[0].humidity);
            this.gauges.outlet.temperature.set(newOutletData[0].temperature);
          }
        },
      },

      async mounted() {
        // Set up socket connection
        this.socket = io('http://localhost:8080');
        this.socket.on('reading', this.onReading);

        // Set up gauges
        gaugeOptions.percentColors = [[0.0, "#7adbff"], [1.0, "#42c5f4"]];
        this.gauges.inlet.humidity = new Gauge(document.getElementById('inlet-humidity'))
          .setOptions(gaugeOptions);
        this.gauges.inlet.humidity.setMinValue(0);
        this.gauges.inlet.humidity.maxValue = 100;
        this.gauges.outlet.humidity = new Gauge(document.getElementById('outlet-humidity'))
          .setOptions(gaugeOptions);
        this.gauges.outlet.humidity.setMinValue(0);
        this.gauges.outlet.humidity.maxValue = 100;

        gaugeOptions.percentColors = [[0.0, "#42c5f4"], [1.0, "#ff4444"]];
        this.gauges.inlet.temperature = new Gauge(document.getElementById('inlet-temperature'))
          .setOptions(gaugeOptions);
        this.gauges.outlet.temperature = new Gauge(document.getElementById('outlet-temperature'))
          .setOptions(gaugeOptions);

        const { data } = await axios.get('/most-recent');
        this.onReading(data);
      },

      methods: {
        onReading(data) {
          // If reading is from inlet sensor
          if (data.inlet) {
            this.sensors.inlet.unshift(data.inlet);
            // Maintain only the most recent 10 readings
            if (this.sensors.inlet.length > 10) {
              this.sensors.inlet.pop()
            }
          }
          // If reading is from outlet sensor
          if (data.outlet) {
            this.sensors.outlet.unshift(data.outlet);
            // Maintain only the most recent 10 readings
            if (this.sensors.outlet.length > 10) {
              this.sensors.outlet.pop()
            }
          }
        },
      },
    });
  </script>

</body>

</html>